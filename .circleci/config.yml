version: 2.1

orbs:
  slack: circleci/slack@4.12.5

executors:
  java-executor:
    docker:
      - image: cimg/openjdk:17.0
    working_directory: ~/project

  machine-executor:
    machine:
      image: ubuntu-2204:current
    resource_class: medium
    working_directory: ~/project

jobs:
  # åç«¯æµ‹è¯•å’Œæ„å»º
  backend-test:
    executor: java-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - maven-deps-v1-{{ checksum "pom.xml" }}
      - run:
          name: Download Dependencies
          command: |
            # æš‚æ—¶æ³¨é‡Šæ‰Mavené•œåƒé…ç½®ï¼Œä½¿ç”¨é»˜è®¤ä¸­å¤®ä»“åº“
            # mvn dependency:go-offline
            mvn dependency:resolve
      - save_cache:
          paths:
            - ~/.m2
          key: maven-deps-v1-{{ checksum "pom.xml" }}
      - run:
          name: Run Tests
          command: mvn test
      - store_test_results:
          path: target/surefire-reports
      - store_artifacts:
          path: target/surefire-reports

  backend-build:
    executor: java-executor
    steps:
      - checkout
      - restore_cache:
          keys:
            - maven-deps-v1-{{ checksum "pom.xml" }}
      - run:
          name: Build Application
          command: |
            # ä½¿ç”¨é»˜è®¤Mavenä»“åº“è¿›è¡Œæ„å»º
            mvn clean package -DskipTests
      - store_artifacts:
          path: target/*.jar
          destination: build-artifacts
      - persist_to_workspace:
          root: .
          paths:
            - target/*.jar
            - Dockerfile
            - docker-compose*.yml
            - scripts

  # æµ‹è¯•ç¯å¢ƒ - å®Œæ•´åº”ç”¨æ ˆæµ‹è¯•
  test-environment:
    executor: machine-executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Install Docker Compose
          command: |
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.21.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
      - run:
          name: Start Test Application Stack
          command: |
            # å¯åŠ¨å®Œæ•´åº”ç”¨æ ˆ
            docker-compose -f docker-compose.test.yml up -d
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 90
      - run:
          name: Run Integration Tests
          command: |
            # å¥åº·æ£€æŸ¥
            timeout 300 bash -c 'until curl -f http://localhost:8080/actuator/health; do sleep 5; done'
            echo "Backend health check passed"
            
            # APIæµ‹è¯•
            curl -f http://localhost:8080/actuator/info || echo "Info endpoint not available"
            
            # æ•°æ®åº“è¿æ¥æµ‹è¯•
            docker-compose -f docker-compose.test.yml exec -T database mysql -u test_user -ptest_pass -e "SELECT 1" || echo "Database test completed"
      - run:
          name: Collect Logs
          command: |
            mkdir -p /tmp/logs
            docker-compose -f docker-compose.test.yml logs backend > /tmp/logs/backend.log
            docker-compose -f docker-compose.test.yml logs database > /tmp/logs/database.log
            docker-compose -f docker-compose.test.yml logs redis > /tmp/logs/redis.log
          when: always
      - store_artifacts:
          path: /tmp/logs
          destination: test-logs
      - run:
          name: Cleanup Test Environment
          command: |
            docker-compose -f docker-compose.test.yml down -v
            docker system prune -f
          when: always
      # æ·»åŠ æˆåŠŸé€šçŸ¥
      - slack/notify:
          event: pass
          channel: $SLACK_DEFAULT_CHANNEL
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âœ… *Food Information Backend* æµ‹è¯•ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼\n*åˆ†æ”¯:* $CIRCLE_BRANCH\n*æäº¤:* $CIRCLE_SHA1\n*æ„å»º:* $CIRCLE_BUILD_NUM\n*é¡¹ç›®:* food-information-backend"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "æŸ¥çœ‹æ„å»º"
                      },
                      "url": "$CIRCLE_BUILD_URL"
                    }
                  ]
                }
              ]
            }

  # ç”Ÿäº§ç¯å¢ƒ - é•¿æœŸè¿è¡Œ
  production-environment:
    executor: machine-executor
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Install Docker Compose
          command: |
            sudo curl -L "https://github.com/docker/compose/releases/download/v2.21.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
      - run:
          name: Deploy Production Stack
          command: |
            # å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
            docker-compose -f docker-compose.prod.yml up -d
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 120
      - run:
          name: Health Check and Get Access Info
          command: |
            # å¥åº·æ£€æŸ¥
            timeout 300 bash -c 'until curl -f http://localhost:8080/actuator/health; do sleep 5; done'
            echo "Production backend health check passed"
            
            # è·å–å¤–éƒ¨è®¿é—®IP
            echo "=== ç”Ÿäº§ç¯å¢ƒè®¿é—®ä¿¡æ¯ ==="
            EXTERNAL_IP=$(curl -s http://checkip.amazonaws.com)
            echo "åç«¯APIåœ°å€: http://$EXTERNAL_IP:8080"
            echo "å¥åº·æ£€æŸ¥: http://$EXTERNAL_IP:8080/actuator/health"
            echo "æ•°æ®åº“åœ°å€: $EXTERNAL_IP:3306"
            echo "Redisåœ°å€: $EXTERNAL_IP:6379"
      - run:
          name: Setup Deploy Marker
          command: |
            # è®°å½•éƒ¨ç½²ä¿¡æ¯
            echo "=== éƒ¨ç½²ä¿¡æ¯ ==="
            echo "éƒ¨ç½²æ—¶é—´: $(date)"
            echo "Gitæäº¤: $CIRCLE_SHA1"
            echo "åˆ†æ”¯: $CIRCLE_BRANCH"
            echo "æ„å»ºå·: $CIRCLE_BUILD_NUM"
      - run:
          name: Setup Monitoring
          command: |
            # æ”¶é›†åº”ç”¨æ—¥å¿—
            mkdir -p /tmp/monitoring
            docker logs food-backend-prod > /tmp/monitoring/backend.log 2>&1 || echo "Backend logs collected"
            docker logs food-database-prod > /tmp/monitoring/database.log 2>&1 || echo "Database logs collected"
            docker logs food-redis-prod > /tmp/monitoring/redis.log 2>&1 || echo "Redis logs collected"
            
            # ç›‘æ§èµ„æºä½¿ç”¨
            docker stats --no-stream > /tmp/monitoring/resource-usage.log
            
            # å¥åº·æ£€æŸ¥è„šæœ¬
            echo '#!/bin/bash' > /tmp/monitoring/health-check.sh
            echo 'curl -f http://localhost:8080/actuator/health' >> /tmp/monitoring/health-check.sh
            chmod +x /tmp/monitoring/health-check.sh
      - store_artifacts:
          path: /tmp/monitoring
          destination: monitoring-logs
      # æ·»åŠ ç”Ÿäº§ç¯å¢ƒæˆåŠŸé€šçŸ¥
      - slack/notify:
          event: pass
          channel: $SLACK_DEFAULT_CHANNEL
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸš€ *Food Information Backend* ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼\n*åˆ†æ”¯:* $CIRCLE_BRANCH\n*æäº¤:* $CIRCLE_SHA1\n*æ„å»º:* $CIRCLE_BUILD_NUM\n*é¡¹ç›®:* food-information-backend"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "æŸ¥çœ‹æ„å»º"
                      },
                      "url": "$CIRCLE_BUILD_URL"
                    }
                  ]
                }
              ]
            }

  # å¤±è´¥é€šçŸ¥job
  notify-failure:
    executor: java-executor
    steps:
      - slack/notify:
          event: fail
          channel: $SLACK_DEFAULT_CHANNEL
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âŒ *Food Information Backend* éƒ¨ç½²å¤±è´¥ï¼\n*åˆ†æ”¯:* $CIRCLE_BRANCH\n*æäº¤:* $CIRCLE_SHA1\n*æ„å»º:* $CIRCLE_BUILD_NUM\n*é¡¹ç›®:* food-information-backend"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "æŸ¥çœ‹å¤±è´¥åŸå› "
                      },
                      "url": "$CIRCLE_BUILD_URL"
                    }
                  ]
                }
              ]
            }

workflows:
  food-information-backend-pipeline:
    jobs:
      # 1. æµ‹è¯•å’Œæ„å»º
      - backend-test:
          filters:
            branches:
              only: [develop, main]
      
      - backend-build:
          requires:
            - backend-test
          filters:
            branches:
              only: [develop, main]
      
      # 2. æµ‹è¯•ç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²
      - test-environment:
          requires:
            - backend-build
          filters:
            branches:
              only: [develop, main]
      
      # 3. æ‰‹åŠ¨æ‰¹å‡†ç”Ÿäº§éƒ¨ç½²
      - hold-production:
          type: approval
          requires:
            - test-environment
          filters:
            branches:
              only: main
      
      # 4. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
      - production-environment:
          requires:
            - hold-production
          filters:
            branches:
              only: main
      
      # 5. å¤±è´¥æ—¶é€šçŸ¥
      - notify-failure:
          requires:
            - backend-test
          filters:
            branches:
              only: [develop, main]